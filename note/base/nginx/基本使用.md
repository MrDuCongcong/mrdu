# Nginx基本使用

## 声明

   本篇文章是在 基于Linux内核的ubuntu操作系统上实践过的，虽然有部分window及基于Linux内核的其他操作系统下的操作，但不会过多详细介绍，实际上整个流程上是一致的。

## 历史

​    [**Nginx**](http://nginx.org/)（engin x）是一个类似于Apache、Tomcat的开源的web服务器，由俄罗斯程序员伊戈尔·

塞索耶夫开发，于2004年公开发布第一个版本0.1.0。Nginx除了可以作为web服务器，也可作为负载均衡器、反向代理服务器等。它有高并发、模块化、可扩展等很多优点。

​    伊戈尔·塞索耶夫在2011年成立了nginx公司，其管理着nginx的商业版本[nginx plus](https://www.nginx.com/)。我们也许需要正确区分nginx.org和nginx.com,前者是nginx的开源社区，后者是商业社区。

​    有关nginx和nginx.plus的对比参考：https://www.nginx.com/products/nginx/#compare-versions。

## 源码

#### 版本

​    打开nginx官网可以看到，nginx有两个版本：主线版本（mainline）和稳定(stable)版本。很明显，nginx的新功能、特性都会在主线版本试水。一般版本号中间数字为奇数的是主线版本，中间数字为偶数的是稳定版本。无论主线版本还是稳定版本都提供了linux和windows版本。



   ![img](https://cdn.nlark.com/yuque/0/2020/png/1062182/1583914835873-a4a695e3-a674-4c14-a4b4-62437a769ca4.png)

#### 源码获取

- windows下可以在[github](https://github.com/nginx/nginx)获取nginx的源码。
- ubuntu下获取nginx源码。

   如上面截图，在nginx的官方下载页面中，在nginx-1.17.9右键->复制链接地址。然后执行下面命令，将源码

   下载到data目录下。wget命令用来从指定的URL下载文件

```shell
root@VM-0-2-ubuntu:/data# wget http://nginx.org/download/nginx-1.17.9.tar.gz
```

​    然后使用下面命令解压压缩包到当前目录。也可以指定目录。

```shell
root@VM-0-2-ubuntu:/data# tar -xzvf nginx.1.17.9.tar.gz
```

​    注意，ubuntu下可能需要获取root权限，否则可能会报错。然后每次执行su命令切换root就好。

```shell
root@VM-0-2-ubuntu:/data# sudo passwd root
```



#### 源码结构

​    在安装nginx之前我们很有必要了解一下它的源码及其结构，因为一般我们是通过编译源码的方式来安装nginx的，这有助于我们对nginx编译过程有个更直观的了解。下面这张图片是我们下载下来的源码的一级目录结构。同时[nginx trac](https://trac.nginx.org/nginx/browser?_ga=2.47467808.606193644.1583909002-580314528.1583909002#nginx/conf)提供了在线查看源码的入口，这是一个基于web的项目管理和bug跟踪系统。



![img](https://cdn.nlark.com/yuque/0/2020/png/1062182/1583920853150-4263ec32-4304-48d0-9020-9a0518473bc3.png)

源码一级目录



- auto：自动检测系统环境及编译相关的脚本。包含四个子目录。

    - cc：与编译器相关的编译检测脚本。
    - lib：译所需一些库的检测脚本。
    - os：平台相关的一些系统参数和系统调用的检测。
    - type：数据类型相关的辅助脚本。

- CHANGES：描述当前版本中提供的新特性，修复的bug，有哪些改变。
- CHANGES.ru：由于作者是俄罗斯人，这个CHANGES文件的俄语版本。
- conf： 一些默认的配置文件，在编译之后会copy到安装目录下。同时也可以作为运维人员的配置 参考。
- congiure\*：这是一个脚本文件，配置编译时产生的一些中间文件，用于编译时执行的一些必备动作。
- contrib：nginx自身提供的一些实用工具，比如能够在vim编辑配置文件时语法高亮的vim配置。
- html：存放一些默认的html页面，一个500的错误页面和一个默认的index.html欢迎页面，在编译后会被copy到安装目录下。
- man：linux下提供的nginx的帮助文件。
- src：nginx的源代码

## 配置vim

   根据上面源码结构的描述，contrib提供了vim的高亮语法配置，我们下面配置一下vim以便使其在编辑nginx的配置文件时高亮显示。

1.找到vim下的vimfiles文件夹，这是vim提供的可以由用户自定义的配置文件目录。

```shell
#  find / -name vimfiles
```

2.在contrib目录下执行命令，将vim下的文件全都copy到vimfiles目录下。

```shell
# cp -r ./vim/* /usr/share/vim/vimfiles/
```

3.用vim打开conf目录下的nginx.conf文件就可以看到语法高亮了。

## 帮助文件查看

   我们执行一下下面的命令查看man目录下执行的帮助信息。

```shell
#  man ./nginx.8
```

   man命令是Linux下的帮助指令，通过man指令可以查看Linux中的指令帮助、配置文件帮助和编程帮助等信息.

## 安装

   nginx安装一般有两种方式，一是直接使用二进制文件，另一种是通过编译源码的方式安装。根据操作系统的不同，在windows平台上一般使用官方提供了二进制包，而在Linux上一般采用编译源码的方式。由于nginx出色的模块化设计方案，nginx二进制文件中只提供了一些默认的功能模块，要想添加自定义功能模块，必须要编译源码安装。二进制安装要相对简单的多，但是编译源码能够给我们足够的自由度，同时也可以根据我们的需要进行自定义配置。下面我们先学习一下配置文件。

## 编译前配置

   回到刚才的源码结构，我们在nginx源码根目录下执行./configure --help查看configure脚本文件中的编译的配置参数。

```shell
root@VM-0-2-ubuntu:/data/nginx-1.17.9# ./configure --help
```

执行该--help命令后展示的配置参数分为四类。

1.路径参数。包括安装部署的根目录、日志路径、配置文件的路径等。截图显示的不完全。

![img](https://cdn.nlark.com/yuque/0/2020/png/1062182/1583983462895-9da9b24d-bdd8-4bbc-b32e-5c9454669bd8.png)

2.编译相关的参数， 如C编译器的路径、C预编译器的路径等。

![img](https://cdn.nlark.com/yuque/0/2020/png/1062182/1583983403668-44dffcfa-08e5-4008-b219-a8c3443cf50b.png)

3.依赖相关软件的参数。比如依赖的PCRE库的参数。

![img](https://cdn.nlark.com/yuque/0/2020/png/1062182/1583983587952-7f4c9252-5bd4-4cc9-badd-e39b26748b6b.png)

4.模块相关的参数。--with-开头的参数表示默认不会编译进去的模块，--without-开头的参数表示默认会编译到安装包中的参数。

![img](https://cdn.nlark.com/yuque/0/2020/png/1062182/1583983912361-a37fccae-0288-4668-8bf2-bc99b106eca9.png)

​    配置文件中的具体信息可以看考官网[从源码构建nginx](http://nginx.org/en/docs/configure.html)。下面仅解释几个比较重要的。

- - **prefix**：作为服务安装的根目录。这个目录会用于除库源路径外的所有相对路径，默认/user/local/nginx
  - **sbin-path**：可执行文件的存放路径。默认值<prefix>/sbin/nginx
  - **conf-path**：配置文件的存放路径。默认值<prefix>/conf/nginx.conf
  - **error-log-path**：错误日志的存放路径。默认值<prefix>/logs/error.log
  - **pid-path**：pid文件的存放路径，内容是ASCAll码存放的主进程id，在执行nginx命令的时候，会读取进程id从而向主进程发出信号, 默认值<prefix>/logs/nginx.pid
  - **modules-path**：定义一个动态模块的存放目录。默认值为<prefix>/modules

​    下面是一个示例的配置文件。执行下面的命令以完成源码的构建。

```shell
root@VM-0-2-ubuntu:/data# ./configure 
                               --prefix=/data/nginx 
                               --conf-path=/nginx.conf 
                               --pid-path=/nginx.pid 
```

​    执行结果如下图。

![img](https://cdn.nlark.com/yuque/0/2020/png/1062182/1584000821219-e1557b2c-9855-47c7-bc82-30033328956e.png)

​    执行成功后会在源代码根目录中生成一个Makefile文件，这相当一个命令的集合，用于‘自动化编译’，这对于最终编译执行的make命令必不可缺。

## 编译

执行下面命令以完成编译安装。make命令是GNU的工程化编译工具。

```shell
root@VM-0-2-ubuntu:/data/nginx-1.17.9# make && make install
```

编译安装成功后，nginx目录如下。

![img](https://cdn.nlark.com/yuque/0/2020/png/1062182/1584079924894-4bef2b25-2a57-4bab-9dd0-b8868b78463e.png)    

 然后使用安装目录下执行以下命令启动nginx。

```shell
sbin/nginx
```

   访问当前服务器地址，默认80端口，如果出现欢迎页面则表示安装成功了。

## 参考文档

【1】[Nginx文件结构及简介](nginx文件结构及简介)

【2】[Nginx配置文件vim下语法高亮显示](https://blog.csdn.net/liuxl57805678/article/details/88358500)

【3】[configure的命令参数（nginx编译选项）](https://blog.csdn.net/weixin_42167759/article/details/84998956)

【4】[ubuntu下安装nginx时依赖库zlib，pcre，openssl安装方法](https://blog.csdn.net/z920954494/article/details/52132125)

【5】[Windows编译Nginx源码](https://www.cnblogs.com/teamblog/p/6128460.html)

【6】[Linux命令大全](https://man.linuxde.net/make)