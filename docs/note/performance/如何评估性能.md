# 前端性能

性能是程序开发中亘古不变的话题，如何评估性能是进行优化的依据。

## 网站跳转时发生了什么？

在面试的时候，面试官往往喜欢问开发者“在浏览器输入URL后发生了什么？”，我们把这个问题扩展一下：假设我们有一个页面，当我们点击页面中的按钮跳转到别的页面，这个过程发生了什么？

1. 卸载当前页面。
2. 重定向
3. 应用缓存
4. 域名解析。导航到网页的第一步就是查找该网页所在的位置，通常我们在地址栏输入的是域名地址，这时候就需要通
5. 建立TCP连接
6. 发送请求
7. 接收响应
8. 

辛运的是，大多数的浏览器厂商都提供了API，以便开发者能够更准确的收集性能细节。


下面这张图来源于W3C官网文档，它是一个描述网页跳转的时序数据的瀑布图。
![](/assets/performance/timestamp-diagram.svg)

## Performance Timing API


## 衡量性能的指标

- 首次内容绘制 (First Content Paint， FCP) 
  
  测量页面从开始加载到页面中的任何内容渲染到屏幕上的时间。
  
- 最大内容绘制 (Largest Content Paint， LCP) 
  
  测量页面从开始加载到页面中最大文本块或者图像元素渲染到屏幕上的时间。LCP应该控制在2.5秒以内。
  
- 首次输入延迟 (First Input Delay， FID) 
  
  测量用户第一次与页面交互（点击连接、按钮），直到浏览器实际对交互做出响应的时间。FID应该控制在100ms或更短。

- 可交互时间 (Time To Interactive， TTI) 
  
  测量页面从开始加载到能够快速响应用户交互所需的时间，此时说明完成了视觉上的渲染、脚步完成加载，并不会对用户的交互产生阻塞。

- 总阻塞时间 (Total Blocking Time， TBT) 
 
  测量页面中的任何内容绘制到屏幕上，到页面可以快速响应用户交互的时间。也就是FCP到TTI之间的时间，这期间，主进程被阻塞时间过长，无法响应用户的交互。

- 累计布局偏移 (Comulative Layout Shift， CLS) 
  
  累计布局偏移是对页面视觉稳定性的量化描述。它指的是页面中意外移动的元素，比如您在阅读文章时，文章内容突然位移，导致您找不到先前阅读的位置；或者当您点击按钮的瞬间，按钮突然移位了；这通常是因为异步加载资源，或者动态操作DOM导致的。那么如何衡量这种意外偏移的频率呢？ Google的工程师使用下面的公式来计算布局偏移分数：
  $$
    布局偏移分数 = 影响分数 * 距离分数
  $$
  - 影响分数指的是：所有不稳定元素在位移前和位移后叠加区域在视图区域的占比。
  - 距离分数指的是：所有不稳定元素在位移前和位移后偏离的最大距离在视图区域的占比。
  
  布局偏移分数衡量页面视觉稳定性的重要指标，所以为了能够使用户获得更好的时间体验，布局偏移分数应控制在0.1以下。

## 测量性能的工具

